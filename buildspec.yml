version: 0.2

phases:
  install:
    commands:
      - echo "Installing dependencies"
      - if ! command -v python3.11 &>/dev/null; then
          echo "Python 3.11 not found. Installing Python 3.11...";
          yum install -y gcc openssl-devel bzip2-devel libffi-devel;
          cd /usr/src;
          wget https://www.python.org/ftp/python/3.11.0/Python-3.11.0.tgz;
          tar xzf Python-3.11.0.tgz;
          cd Python-3.11.0;
          ./configure --enable-optimizations;
          make altinstall;
          ln -s /usr/local/bin/python3.11 /usr/bin/python3.11;
        else
          echo "Python 3.11 is already installed.";
        fi
  pre_build:
    commands:
      - echo "Running pre-build phase"
      - python3.11 --version  
  build:
    commands:
      - echo "Building the SAM application"
      - sam build --template-file template.yaml  
  post_build:
    commands:
      - echo "Deploying the resume website to S3"
      - ls -la src/website  
      - aws s3 sync src/website s3://adam-agbaria --delete
      - echo "Checking CloudFormation stack status"
      - >
        STACK_STATUS=$(aws cloudformation describe-stacks --stack-name ResumeWebsiteStack --query 'Stacks[0].StackStatus' --output text 2>&1 || true)
      - >
        if [[ "$STACK_STATUS" == "ROLLBACK_FAILED" ]] || [[ "$STACK_STATUS" == "DELETE_FAILED" ]] || [[ "$STACK_STATUS" == "ROLLBACK_COMPLETE" ]]; then
          echo "Stack is in $STACK_STATUS state. Deleting stack...";
          aws cloudformation delete-stack --stack-name ResumeWebsiteStack;
          echo "Waiting for stack to be deleted...";
          aws cloudformation wait stack-delete-complete --stack-name ResumeWebsiteStack;
        elif [[ "$STACK_STATUS" == *"does not exist"* ]]; then
          echo "Stack does not exist. Proceeding with deployment.";
        else
          echo "Stack exists and is in status: $STACK_STATUS";
        fi
      - echo "Retrieving the latest Lambda function names"
      - BUILD_FUNCTION_NAME=$(aws cloudformation describe-stack-resource --stack-name ResumeWebsiteStack --logical-resource-id BuildFunction --query 'StackResourceDetail.PhysicalResourceId' --output text)
      - NOTIFICATION_FUNCTION_NAME=$(aws cloudformation describe-stack-resource --stack-name ResumeWebsiteStack --logical-resource-id NotificationFunction --query 'StackResourceDetail.PhysicalResourceId' --output text)
      - echo "Checking if $BUILD_FUNCTION_NAME exists"
      - if ! aws lambda get-function --function-name $BUILD_FUNCTION_NAME; then
          echo "$BUILD_FUNCTION_NAME does not exist. Deploying function...";
          sam deploy --template-file template.yaml --stack-name ResumeWebsiteStack --capabilities CAPABILITY_IAM --s3-bucket adam-agbaria;
        else
          echo "$BUILD_FUNCTION_NAME exists. Proceeding with deployment.";
        fi
      - echo "Invoking the Lambda function: $BUILD_FUNCTION_NAME"
      - >
        aws lambda invoke --function-name $BUILD_FUNCTION_NAME --payload '{"project_name": "ResumeWebsite", "s3_bucket": "adam-agbaria"}' /tmp/lambda_output.txt --cli-binary-format raw-in-base64-out
      - echo "Invoking the Notification Lambda function: $NOTIFICATION_FUNCTION_NAME"
      - >
        aws lambda invoke --function-name $NOTIFICATION_FUNCTION_NAME --payload '{"topic_arn": "your-sns-topic-arn", "message": "Resume Website Deployed Successfully"}' /tmp/notify_output.txt --cli-binary-format raw-in-base64-out

artifacts:
  files:
    - '**/*'
